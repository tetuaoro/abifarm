var lt=Object.create;var A=Object.defineProperty,ht=Object.defineProperties,ut=Object.getOwnPropertyDescriptor,pt=Object.getOwnPropertyDescriptors,dt=Object.getOwnPropertyNames,q=Object.getOwnPropertySymbols,ft=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty,mt=Object.prototype.propertyIsEnumerable;var V=(n,t,e)=>t in n?A(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,W=(n,t)=>{for(var e in t||(t={}))z.call(t,e)&&V(n,e,t[e]);if(q)for(var e of q(t))mt.call(t,e)&&V(n,e,t[e]);return n},G=(n,t)=>ht(n,pt(t)),yt=n=>A(n,"__esModule",{value:!0});var gt=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of dt(t))!z.call(n,s)&&(e||s!=="default")&&A(n,s,{get:()=>t[s],enumerable:!(r=ut(t,s))||r.enumerable});return n},g=(n,t)=>gt(yt(A(n!=null?lt(ft(n)):{},"default",!t&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var H=require("../node_modules/dotenv/lib/main.js"),$=require("../node_modules/@binance/connector/src/index.js");var E=(n,t)=>{if(!n)return;let e=t&&t=="pop";for(let r=0;r<n.length;r++)e?n.pop():n.shift()},J=(n,t,e)=>{let r=n.values(),s=r.next();for(;!s.done;){let{base:i,quote:o}=s.value;if(t===i&&e===o||t===o&&e===i)return s.value;s=r.next()}};var Y=(n,t,e)=>t==0?0:e==="percentage"?100*((n-t)/t):(n-t)/t,_=[],O=[],j=async(n,t,e)=>{await n(),_[e]&&O.push(setTimeout(()=>j(n,t,e),t))},w=(n,t)=>{if(n&&typeof n=="function"){let e=_.length;return _.push(!0),t=t||0,j(n,t,e),e}else throw new Error("Callback must be a function")},I=n=>{_[n]&&(_[n]=!1,clearTimeout(O[n])),_.every(t=>t===!1)&&(E(_),E(O))};process.on("exit",()=>{let n=O.length;for(let t=0;t<n;t++)clearInterval(O[0]),O.shift();console.log("\u{1F300} purge utils")});var x=class{constructor(){this.events=new Map;this.stacks=new Map;this.eventsOnce=new Map}on(t,e,r){if(r==="REPLACE"&&this.events.set(t,e),r==="STACK"){let s=this.stacks.get(t);if(!s){let i=new Array;i.push(e),this.stacks.set(t,i);return}s.push(e),this.stacks.set(t,s)}r||this.events.has(t)||this.events.set(t,e)}once(t,e){this.eventsOnce.has(t)||this.eventsOnce.set(t,e)}emit(t,...e){if(console.log("\u{1F442} emit event",t,"with",typeof e,"params"),this.events.has(t)&&this.events.get(t)(...e),this.eventsOnce.has(t)){let r=this.eventsOnce.get(t);this.eventsOnce.delete(t),r(...e)}this.stacks.has(t)&&this.stacks.get(t).forEach(s=>{s(...e)})}},M=class{constructor(t){this.symbol=t,this.stable=this.symbol==="USDT"||this.symbol==="BUSD"||this.symbol==="USDC"||this.symbol==="UST"||this.symbol==="USDP"||this.symbol==="DAI"}},y=class{constructor(t,e,r,s){this.coin=t,this.next=e||null,this.pair=r||null,this.depth=s||1,this.orderXtras=new Map}previous(t){let e=this,r=e;for(;e.next&&e!=t;)r=e,e=e.next;return r}name(){let t="",e=this;for(;e;)t+=e.coin.symbol,e=e.next;return t}setOrderXtras(t,e){this.orderXtras.set(e,t)}setPair(t){if(t instanceof Set){if(!this.next)return;let e=this.coin,r=this;for(;r;)r.setPair(J(t,r.coin,r.next?r.next.coin:e)),r=r.next}else this.pair=t}reverse(){let t=this;for(;t.next;)t=t.next;let e=new y(t.coin,null,t.pair,this.depth),r=e,s=1;for(;s<this.depth;)t=this.previous(t),e.next=new y(t.coin,null,t.pair,this.depth-s),e=e.next,s++;return r}},N=class{constructor(t,e){this.base=t,this.quote=e,this.symbol=t.symbol+e.symbol,this._ticker24hr=new Map,this.filters=new Array}setPrecision(t,e){this._baseAssetPrecision=t,this._quoteAssetPrecision=e}getPrecisions(){return{baseAssetPrecision:this._baseAssetPrecision,quoteAssetPrecision:this._quoteAssetPrecision}}setFilters(t){t.forEach(e=>{this.filters.find(r=>r.filterType==e.filterType)||this.filters.push(e)})}getMarketTicker24hr(t){return this._ticker24hr.get(t)}setTicker24hr(t,e){this._ticker24hr.set(e,t)}};var R=class extends x{constructor(t){super();this.id=t,this._attach=new Map,this._coins=new Map,this._pairs=new Map}addCoin(t,e){let r=this._coins.get(e)||this._coins.set(e,new Set).get(e),s=r.values(),i=s.next(),o;for(;!i.done&&!o;){let a=i.value;a.symbol==t&&(o=a),i=s.next()}return o||(o=new M(t),r.add(o),o)}addPair(t,e,r){let s=this._pairs.get(r)||this._pairs.set(r,new Set).get(r),i=s.values(),o=i.next(),a;for(;!o.done&&!a;){let c=o.value;c.base==t&&c.quote==e&&(a=c),o=i.next()}return a||(a=new N(t,e),s.add(a),a)}coins(t){return this._coins.get(t)}pairs(t){return this._pairs.get(t)}add(t,e){this._attach.has(t)?this._attach.get(t).add(e):this._attach.set(t,new Set([e])),this._attach.has(e)?this._attach.get(e).add(t):this._attach.set(e,new Set([t]))}_dfs(t,e){if(t<=0)return;let s=new Set(e).values(),i=s.next();for(;!i.done;){let o=i.value,a=i.value;i=s.next();let c=new Set;for(;a.next;)c.add(a.next.coin),a=a.next;let l=this._attach.get(o.coin).values(),h=l.next();for(;!h.done;){let b=h.value;h=l.next(),!c.has(b)&&e.add(new y(b,o,null,o.depth+1))}e.delete(o)}this._dfs(t-1,e)}_filter(t,e){e.forEach(r=>{this._attach.get(r.coin).has(t)||e.delete(r)})}pathCoinToString(t){let e="";for(;t;)e+=t.coin.symbol+(t.next?" ":""),t=t.next;return e}};var F=g(require("fs")),U=g(require("../node_modules/lodash/lodash.js"));(0,H.config)();var _t=process.env.BINANCE_API_KEY_PROD,bt=process.env.BINANCE_API_SECRET_PROD,u=class extends R{constructor(){super("binance");this._client=new $.Spot(_t,bt),this.binancePaths=new Map,this.BUSDPaths=new Set,this.tPairs=new Set,this.userBalances=new Map,this.ORDERS_ON_TRADE=new Set,this.STACKS_INFO=new Array,process.on("exit",()=>{E(this.STACKS_INFO),this.binancePaths.clear(),this.BUSDPaths.clear(),this.tPairs.clear(),this.userBalances.clear(),this.ORDERS_ON_TRADE.clear(),console.log("\u{1F300} purge binance constructor")})}async _account(){try{console.log("\u{1F4B0} update account user data");let{data:t}=await this._client.account();if(t.permissions&&t.permissions.length!=1)throw new Error("The api key needs to be 'SPOT' only !");return t.balances.forEach(e=>{(parseFloat(e.free)!=0||parseFloat(e.locked)!=0)&&(this.userBalances.set(e.asset,e),console.log("\u{1F4B8} asset",e.asset,"free",e.free,"locked",e.locked))}),this.on(u.ON_outboundAccountPosition,e=>{try{e.B.forEach(r=>{this.userBalances.set(r.a,{asset:r.a,free:r.f,locked:r.l})})}catch(r){this.emit(u.EVT_ERROR,r)}}),this.on(u.ON_balanceUpdate,e=>{try{let r=setTimeout(async()=>{await this._account(),clearTimeout(r)},10**3*3)}catch(r){this.emit(u.EVT_ERROR,r)}}),t}catch(t){throw t}}async _startStream(){try{let t={open:()=>console.log("\u{1F440} open stream"),close:()=>console.log("\u{1F440} closed stream"),message:i=>{console.log("ws emitting",i),typeof i=="string"&&(i=JSON.parse(i)),i.e==u.ON_executionReport&&this.emit(u.ON_executionReport,i),i.e==u.ON_outboundAccountPosition&&this.emit(u.ON_outboundAccountPosition,i),i.e==u.ON_balanceUpdate&&this.emit(u.ON_balanceUpdate,i)}},e,r;process.on("exit",()=>{r&&this._client.unsubscribe(r),e&&console.log("unsubscribe ws",e)});let s=w(async()=>{try{if(e&&(await this._client.renewListenKey(e),console.log("\u{1F440} renewed ListenKey")),!e){let{data:i}=await this._client.createListenKey();e=i.listenKey,r=await this._client.userData(e,t),console.log("subscribe ws",e);let o=setInterval(()=>{try{r&&(r.ws.ping(),console.log("Sended ping from client"))}catch(a){this.emit(u.EVT_ERROR,a)}},10**3*60*5);C.push(o)}}catch(i){this.emit(u.EVT_ERROR,i)}},10**3*60*55);T.push(s)}catch(t){throw t}}async init(t){console.log("\u264D Initialize binance");try{await this._startStream(),await this._account();let{data:e}=await this._client.exchangeInfo();e.symbols.forEach(i=>{if(i.orderTypes.includes("LIMIT")&&i.permissions.includes("SPOT")&&i.isSpotTradingAllowed){let o=this.addCoin(i.baseAsset,this),a=this.addCoin(i.quoteAsset,this),c=this.addPair(o,a,this);c.setFilters(i.filters),c.setPrecision(i.baseAssetPrecision,i.quoteAssetPrecision),this.add(o,a)}}),t||(t=3);let r=this.coins(this),s=this.pairs(this);r.forEach(i=>{let o=new Set([new y(i)]);this._dfs(t-1,o),this._filter(i,o),o.forEach(a=>{a=a.reverse(),a.setPair(s),this.binancePaths.set(a.name(),a)})}),this.binancePaths.forEach((i,o)=>{o.startsWith("BUSD")&&this.BUSDPaths.add(i)})}catch(e){throw e}}_normalizeWithLotSize(t,e){try{let{stepSize:r}=t.filters.find(i=>i.filterType=="LOT_SIZE"),s=r.split(".")[1].indexOf("1");return s==-1?Math.trunc(e):Math.trunc(e*10**(s+1))/10**(s+1)}catch(r){throw r}}_getPriceInfo(t,e,r,s){try{let{quoteAssetPrecision:i}=e.getPrecisions(),o,a;return e.base==s?(o=this._normalizeWithLotSize(e,r),a=Math.trunc(o*t*10**i)/10**i,{output:a,side:"SELL",quantity:o,price:t}):(a=Math.trunc(r*10**i)/10**i,o=this._normalizeWithLotSize(e,a/t),a=Math.trunc(t*o*10**i)/10**i,{output:a,side:"BUY",quantity:o,price:t})}catch(i){throw i}}_arbitrage(t,e,r=[],s=[],i=[],o=[]){let a=t.coin,c=t.pair,l=c.base==a?parseFloat(c.getMarketTicker24hr(this).bidPrice):parseFloat(c.getMarketTicker24hr(this).askPrice),h=this._getPriceInfo(l,c,e,a);return i.push(c.symbol),r.push(h.quantity),s.push(h.side),o.push(l),t.next?this._arbitrage(t.next,c.base==a?h.output:h.quantity,r,s,i,o):{output:c.base==a?h.output:h.quantity,quantities:r,sides:s,symbols:i,wps:o}}_bestPaths(t,e,r){r=r||1;let s=[],i=t.values(),o=i.next();for(;!o.done;){let a=o.value,{output:c,quantities:l,sides:h,symbols:b,wps:p}=this._arbitrage(a,e),S=Y(c,e,"percentage"),{bidPrice:k,askPrice:m}=a.pair.getMarketTicker24hr(this),{bidPrice:nt,askPrice:at}=a.next.pair.getMarketTicker24hr(this),{bidPrice:ot,askPrice:ct}=a.next.next.pair.getMarketTicker24hr(this);!Number.isFinite(S)||S<r?t.delete(a):(a.setOrderXtras({input:e,output:c,multiple:Math.trunc(S*10**3)/10**3,quantities:l,sides:h,symbols:b,wps:p},this),s.push({p:a,path:this.pathCoinToString(a),multiple:Math.trunc(S*10**3)/10**3,input:e,output:c,quantities:l.toString(),sides:h.toString(),bids:[k,nt,ot].toString(),asks:[m,at,ct].toString()})),o=i.next()}t.clear(),s.length>0&&(s.sort((a,c)=>a.multiple>c.multiple?-1:1).forEach(({p:a})=>t.add(a)),console.table(s.filter((a,c)=>c<5),["path","multiple","output","quantities","sides","bids","asks"]))}async triangleBUSD(t){try{let{free:e}=this.userBalances.get("BUSD");if(e&&parseFloat(e)<100)return console.log("\u{1F4B0} triangleBUSD: busd balance less than 100 !"),new Set;await this._updatePairsTicker24hr(this.pairs(this));let r=new Set(this.BUSDPaths);return this._bestPaths(r,100,t),r}catch(e){throw e}}async _updatePairsTicker24hr(t){try{let{data:e}=await this._client.ticker24hr();t.forEach(r=>{let s=e.find(i=>i.symbol==r.symbol);s&&r.setTicker24hr(s,this)})}catch(e){throw e}}async _stackOrders(t,e,r){try{let{sides:s,symbols:i,quantities:o,wps:a}=e;if(r||(r=0),r>=s.length){this._manageOrders(e,"d"),this.ORDERS_ON_TRADE.delete(t.name());return}let c=p=>{let S=this.STACKS_INFO.filter(m=>!U.default.isEqual(p,m)),k=this.STACKS_INFO.length;for(let m=0;m<k;m++)this.STACKS_INFO.pop();for(let m of S)this.STACKS_INFO.push(m)},l,h=!1;this.on(u.ON_executionReport,p=>{console.log("\u{1F4B1}",u.ON_executionReport,p.X),!h&&(p&&l&&p.c==l.clientOrderId&&p.X=="FILLED"&&(h=!0,c({dataOrder:l,phase:r}),r++,this._stackOrders(t,e,r)),p&&l&&p.C==l.clientOrderId&&p.X=="CANCELED"&&(h=!0,c({dataOrder:l,phase:r}),this._stackOrders(t,e,s.length)))},"REPLACE");let b=w(async()=>{try{if(h){I(b);return}if(l){let{data:p}=await this._client.getOrder(l.symbol,{origClientOrderId:l.clientOrderId,recvWindow:6e3,timestamp:Date.now()});console.log("\u{1F4B1} async check order",p.status,p.symbol),p.status=="FILLED"&&(h=!0,r++,this._stackOrders(t,e,r),c({dataOrder:l,phase:r-1})),p.status=="CANCELED"&&(h=!0,this._stackOrders(t,e,s.length),c({dataOrder:l,phase:r}))}}catch(p){this.emit(u.EVT_ERROR,p)}},10**3*6);l=await this._newOrder(i[r],s[r],"LIMIT",{price:a[r],quantity:o[r]}),e&&e.orders||(e.orders=new Array),e.orders.push(l),this._manageOrders(e,"u"),this.STACKS_INFO.push({dataOrder:l,phase:r})}catch(s){this.emit(u.EVT_ERROR,s)}}async _readOrders(){try{let t=__dirname+`/orders.${this.id}.json`,e=F.default.readFileSync(t,{flag:"r+"});return JSON.parse(e.toString())}catch{return[]}}async _writeOrders(t){try{try{let e=__dirname+`/orders.${this.id}.json`;F.default.writeFileSync(e,JSON.stringify(t),{flag:"w+",encoding:"utf8"})}catch(e){throw e}}catch(e){throw e}}async _manageOrders(t,e){try{let r=await this._readOrders();t&&e&&e=="a"&&r.push(t),t&&e&&e=="d"&&(r=r.filter(s=>!U.default.isEqual(s,t))),t&&e&&e=="u"&&(r=r.filter(s=>s.id!=t.id),r.push(t)),e&&await this._writeOrders(r)}catch(r){this.emit(u.EVT_ERROR,r)}}async retrade(){try{let t=await this._readOrders();for(let e of t){let{orders:r,sides:s}=e;if(s.length!=r.length){let{free:i}=this.userBalances.get("BUSD");if(i&&parseFloat(i)<100)continue}}}catch(t){throw t}}async _newOrder(t,e,r,s){try{s.timeInForce=s.timeInForce||"GTC",s.recvWindow=s.recvWindow||5e3;let{data:i}=await this._client.newOrder(t,e,r,s);return i}catch(i){throw i}}async trade(t,e){try{let{free:r}=this.userBalances.get(e||"BUSD");if(r&&parseFloat(r)<100){console.log("\u{1F4B0} busd balance less than 100 !");return}if(this.ORDERS_ON_TRADE.has(t.name())){console.log("\u{1F4B9} this path already existed on trade spot !");return}this.ORDERS_ON_TRADE.add(t.name());let s=t.orderXtras.get(this);s&&!s.id&&(s.id=this.id+"_"+Date.now().toString()),this._manageOrders(s,"a"),this._stackOrders(t,s)}catch(r){throw r}}},f=u;f.EVT_ERROR="binance_error",f.ON_executionReport="executionReport",f.ON_outboundAccountPosition="outboundAccountPosition",f.ON_balanceUpdate="balanceUpdate";var C=[],T=[];process.on("exit",()=>{let n=C.length;for(let t=0;t<n;t++)clearInterval(C[0]),C.shift();n=T.length;for(let t=0;t<n;t++)I(T[0]),T.shift();console.log("\u{1F300} purge Binance")});var B=g(require("../node_modules/@sendgrid/mail/index.js")),Q=g(require("../node_modules/hogan.js/lib/hogan.js")),Z=g(require("../node_modules/inline-css/index.js")),tt=g(require("fs")),et=require("../node_modules/dotenv/lib/main.js");(0,et.config)();var St=process.env.SENDGRID_API_KEY,Ot=process.env.SENDGRID_FROM,Pt=process.env.SENDGRID_TO;B.default.setApiKey(St);var rt=async(n,t)=>{try{let{COUNTER_APP:e,COUNTER_ERRORS:r}=t,s=tt.default.readFileSync(__dirname+"/template/report.html"),i={to:Pt,from:Ot,subject:"Abifarm report"},o=await(0,Z.default)(s.toString(),{url:"file://"+__dirname+"/template/"}),a=Q.default.compile(o),c={market:n.id,counter_e:r,counter_a:e,m_coins:n.coins(n).size,m_pairs:n.pairs(n).size,m_paths:n.binancePaths.size,m_paths_busd:n.BUSDPaths.size},l=a.render(c),h=G(W({},i),{html:l});await B.default.send(h),console.log("\u{1F4E7} report sended !")}catch(e){console.error(e)}};var st=g(require("../node_modules/node-cron/src/node-cron.js")),K=.32517,d=new f,L=0,v=0,wt=async()=>{console.log("\u{1F535} Main initialize:","selectPercent",K);try{d.on(f.EVT_ERROR,n=>{P("\u274C from binance:evtError",n)}),await d.init(),await It()}catch(n){P("\u274C from main catch",n)}},It=async()=>{console.log("\u{1F536} App launched");try{D.push(w(async()=>{try{++v,v%10==0&&console.log("\u{1F916}",v,L,K,"binance: coins",d.coins(d).size,"pairs",d.pairs(d).size,"busd",d.BUSDPaths.size,"paths",d.binancePaths.size),d.STACKS_INFO.length>0&&d.STACKS_INFO.forEach(t=>{let{phase:e,dataOrder:r}=t,{price:s,symbol:i,origQty:o,side:a}=r;console.log("\u2653","phase",e,i,s,o,a)});let n=await d.triangleBUSD(K);if(n.size>0){let t=n.values(),e=t.next(),r=0,s;for(;!e.done;){let i=e.value,o=i.orderXtras.get(d).multiple;o>r&&(s=i,r=o),e=t.next()}if(s)try{await d.trade(s)}catch(i){P("\u274C from app:trade catch",i)}}}catch(n){P("\u274C from app:async catch",n)}},10**3*3))}catch(n){P("\u274C from app catch",n)}},P=(n,t)=>{L++,console.error(n||"\u274C from makeError catch");let e=!0;t&&t.data&&(console.error(t.data),e=!1),t&&t.config&&t.config.url&&(console.error(t.config.url),e=!1),t&&t.response&&t.response&&(console.error(t.response.status,t.response.statusText),e=!1),e&&console.error(t),console.error(n||"\u274C from makeError catch")};st.default.schedule("59 22 * * *",async()=>{try{console.log("---------------------"),console.log("Running Cron Job"),await rt(d,{COUNTER_APP:v,COUNTER_ERRORS:L})}catch(n){P("\u274C from cron catch",n)}});wt();var D=[],it=!1,X=()=>{if(it)return;it=!0;let n=D.length;for(let t=0;t<n;t++)I(D[0]),D.shift();console.log("\u{1F300} purge main"),process.exit()};process.on("SIGTERM",X);process.on("SIGINT",X);process.on("exit",X);
