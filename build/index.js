var Q=Object.create;var v=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames;var et=Object.getPrototypeOf,rt=Object.prototype.hasOwnProperty;var st=n=>v(n,"__esModule",{value:!0});var it=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of tt(t))!rt.call(n,s)&&(e||s!=="default")&&v(n,s,{get:()=>t[s],enumerable:!(r=Z(t,s))||r.enumerable});return n},B=(n,t)=>it(st(v(n!=null?Q(et(n)):{},"default",!t&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var V=require("../node_modules/dotenv/lib/main.js"),W=require("../node_modules/@binance/connector/src/index.js");var I=(n,t)=>{if(!n)return;let e=t&&t=="pop";for(let r=0;r<n.length;r++)e?n.pop():n.shift()},K=(n,t,e)=>{let r=n.values(),s=r.next();for(;!s.done;){let{base:i,quote:o}=s.value;if(t===i&&e===o||t===o&&e===i)return s.value;s=r.next()}};var X=(n,t,e)=>t==0?0:e==="percentage"?100*((n-t)/t):(n-t)/t,g=[],S=[],q=async(n,t,e)=>{await n(),g[e]&&S.push(setTimeout(()=>q(n,t,e),t))},O=(n,t)=>{if(n&&typeof n=="function"){let e=g.length;return g.push(!0),t=t||0,q(n,t,e),e}else throw new Error("Callback must be a function")},w=n=>{g[n]&&(g[n]=!1,clearTimeout(S[n])),g.every(t=>t===!1)&&(I(g),I(S))};process.on("exit",()=>{let n=S.length;for(let t=0;t<n;t++)clearInterval(S[0]),S.shift();console.log("\u{1F300} purge utils")});var k=class{constructor(){this.events=new Map;this.stacks=new Map;this.eventsOnce=new Map}on(t,e,r){if(r==="REPLACE"&&this.events.set(t,e),r==="STACK"){let s=this.stacks.get(t);if(!s){let i=new Array;i.push(e),this.stacks.set(t,i);return}s.push(e),this.stacks.set(t,s)}r||this.events.has(t)||this.events.set(t,e)}once(t,e){this.eventsOnce.has(t)||this.eventsOnce.set(t,e)}emit(t,...e){if(console.log("\u{1F442} emit event",t,"with",typeof e,"params"),this.events.has(t)&&this.events.get(t)(...e),this.eventsOnce.has(t)){let r=this.eventsOnce.get(t);this.eventsOnce.delete(t),r(...e)}this.stacks.has(t)&&this.stacks.get(t).forEach(s=>{s(...e)})}},x=class{constructor(t){this.symbol=t,this.stable=this.symbol==="USDT"||this.symbol==="BUSD"||this.symbol==="USDC"||this.symbol==="UST"||this.symbol==="USDP"||this.symbol==="DAI"}},y=class{constructor(t,e,r,s){this.coin=t,this.next=e||null,this.pair=r||null,this.depth=s||1,this.orderXtras=new Map}previous(t){let e=this,r=e;for(;e.next&&e!=t;)r=e,e=e.next;return r}name(){let t="",e=this;for(;e;)t+=e.coin.symbol,e=e.next;return t}setOrderXtras(t,e){this.orderXtras.set(e,t)}setPair(t){if(t instanceof Set){if(!this.next)return;let e=this.coin,r=this;for(;r;)r.setPair(K(t,r.coin,r.next?r.next.coin:e)),r=r.next}else this.pair=t}reverse(){let t=this;for(;t.next;)t=t.next;let e=new y(t.coin,null,t.pair,this.depth),r=e,s=1;for(;s<this.depth;)t=this.previous(t),e.next=new y(t.coin,null,t.pair,this.depth-s),e=e.next,s++;return r}},D=class{constructor(t,e){this.base=t,this.quote=e,this.symbol=t.symbol+e.symbol,this._ticker24hr=new Map,this.filters=new Array}setPrecision(t,e){this._baseAssetPrecision=t,this._quoteAssetPrecision=e}getPrecisions(){return{baseAssetPrecision:this._baseAssetPrecision,quoteAssetPrecision:this._quoteAssetPrecision}}setFilters(t){t.forEach(e=>{this.filters.find(r=>r.filterType==e.filterType)||this.filters.push(e)})}getMarketTicker24hr(t){return this._ticker24hr.get(t)}setTicker24hr(t,e){this._ticker24hr.set(e,t)}};var z=class extends k{constructor(){super();this._coins=new Map,this._pairs=new Map}addCoin(t,e){let r=this._coins.get(e)||this._coins.set(e,new Set).get(e),s=r.values(),i=s.next(),o;for(;!i.done&&!o;){let a=i.value;a.symbol==t&&(o=a),i=s.next()}return o||(o=new x(t),r.add(o),o)}addPair(t,e,r){let s=this._pairs.get(r)||this._pairs.set(r,new Set).get(r),i=s.values(),o=i.next(),a;for(;!o.done&&!a;){let c=o.value;c.base==t&&c.quote==e&&(a=c),o=i.next()}return a||(a=new D(t,e),s.add(a),a)}coins(t){return this._coins.get(t)}pairs(t){return this._pairs.get(t)}},A=class extends z{constructor(t){super();this.id=t,this._attach=new Map}add(t,e){this._attach.has(t)?this._attach.get(t).add(e):this._attach.set(t,new Set([e])),this._attach.has(e)?this._attach.get(e).add(t):this._attach.set(e,new Set([t]))}_dfs(t,e){if(t<=0)return;let s=new Set(e).values(),i=s.next();for(;!i.done;){let o=i.value,a=i.value;i=s.next();let c=new Set;for(;a.next;)c.add(a.next.coin),a=a.next;let l=this._attach.get(o.coin).values(),h=l.next();for(;!h.done;){let _=h.value;h=l.next(),!c.has(_)&&e.add(new y(_,o,null,o.depth+1))}e.delete(o)}this._dfs(t-1,e)}_filter(t,e){e.forEach(r=>{this._attach.get(r.coin).has(t)||e.delete(r)})}pathCoinToString(t){let e="";for(;t;)e+=t.coin.symbol+(t.next?" ":""),t=t.next;return e}};var M=B(require("fs")),N=B(require("../node_modules/lodash/lodash.js"));(0,V.config)();var nt=process.env.BINANCE_API_KEY_PROD,at=process.env.BINANCE_API_SECRET_PROD,u=class extends A{constructor(){super("binance");this._client=new W.Spot(nt,at),this.binancePaths=new Map,this.BUSDPaths=new Set,this.tPairs=new Set,this.userBalances=new Map,this.ORDERS_ON_TRADE=new Set,this.STACKS_INFO=new Array,process.on("exit",()=>{I(this.STACKS_INFO),this.binancePaths.clear(),this.BUSDPaths.clear(),this.tPairs.clear(),this.userBalances.clear(),this.ORDERS_ON_TRADE.clear(),console.log("\u{1F300} purge binance constructor")})}async _account(){try{console.log("\u{1F4B0} update account user data");let{data:t}=await this._client.account();if(t.permissions&&t.permissions.length!=1)throw new Error("The api key needs to be 'SPOT' only !");return t.balances.forEach(e=>{(parseFloat(e.free)!=0||parseFloat(e.locked)!=0)&&(this.userBalances.set(e.asset,e),console.log("\u{1F4B8} asset",e.asset,"free",e.free,"locked",e.locked))}),this.on(u.ON_outboundAccountPosition,e=>{try{e.B.forEach(r=>{this.userBalances.set(r.a,{asset:r.a,free:r.f,locked:r.l})})}catch(r){this.emit(u.EVT_ERROR,r)}}),this.on(u.ON_balanceUpdate,async e=>{try{await this._account()}catch(r){this.emit(u.EVT_ERROR,r)}}),t}catch(t){throw t}}async _startStream(){try{let t={open:()=>console.log("\u{1F440} open stream"),close:()=>console.log("\u{1F440} closed stream"),message:i=>{console.log("ws emitting",i),typeof i=="string"&&(i=JSON.parse(i)),i.e==u.ON_executionReport&&this.emit(u.ON_executionReport,i),i.e==u.ON_outboundAccountPosition&&this.emit(u.ON_outboundAccountPosition,i),i.e==u.ON_balanceUpdate&&this.emit(u.ON_balanceUpdate,i)}},e,r;process.on("exit",()=>{r&&this._client.unsubscribe(r),e&&console.log("unsubscribe ws",e)});let s=O(async()=>{try{if(e&&(await this._client.renewListenKey(e),console.log("\u{1F440} renewed ListenKey")),!e){let{data:i}=await this._client.createListenKey();e=i.listenKey,r=await this._client.userData(e,t),console.log("subscribe ws",e);let o=setInterval(()=>{try{r&&(r.ws.ping(),console.log("Sended ping from client"))}catch(a){this.emit(u.EVT_ERROR,a)}},10**3*60*5);E.push(o)}}catch(i){this.emit(u.EVT_ERROR,i)}},10**3*60*55);C.push(s)}catch(t){throw t}}async init(t){console.log("\u264D Initialize binance");try{await this._startStream(),await this._account();let{data:e}=await this._client.exchangeInfo();e.symbols.forEach(i=>{if(i.orderTypes.includes("LIMIT")&&i.permissions.includes("SPOT")&&i.isSpotTradingAllowed){let o=this.addCoin(i.baseAsset,this),a=this.addCoin(i.quoteAsset,this),c=this.addPair(o,a,this);c.setFilters(i.filters),c.setPrecision(i.baseAssetPrecision,i.quoteAssetPrecision),this.add(o,a)}}),t||(t=3);let r=this.coins(this),s=this.pairs(this);r.forEach(i=>{let o=new Set([new y(i)]);this._dfs(t-1,o),this._filter(i,o),o.forEach(a=>{a=a.reverse(),a.setPair(s),this.binancePaths.set(a.name(),a)})}),this.binancePaths.forEach((i,o)=>{o.startsWith("BUSD")&&this.BUSDPaths.add(i)})}catch(e){throw e}}_normalizeWithLotSize(t,e){try{let{stepSize:r}=t.filters.find(i=>i.filterType=="LOT_SIZE"),s=r.split(".")[1].indexOf("1");return s==-1?Math.trunc(e):Math.trunc(e*10**(s+1))/10**(s+1)}catch(r){throw r}}_getPriceInfo(t,e,r,s){try{let{quoteAssetPrecision:i}=e.getPrecisions(),o,a;return e.base==s?(o=this._normalizeWithLotSize(e,r),a=Math.trunc(o*t*10**i)/10**i,{output:a,side:"SELL",quantity:o,price:t}):(a=Math.trunc(r*10**i)/10**i,o=this._normalizeWithLotSize(e,a/t),a=Math.trunc(t*o*10**i)/10**i,{output:a,side:"BUY",quantity:o,price:t})}catch(i){throw i}}_arbitrage(t,e,r=[],s=[],i=[],o=[]){let a=t.coin,c=t.pair,l=c.base==a?parseFloat(c.getMarketTicker24hr(this).bidPrice):parseFloat(c.getMarketTicker24hr(this).askPrice),h=this._getPriceInfo(l,c,e,a);return i.push(c.symbol),r.push(h.quantity),s.push(h.side),o.push(l),t.next?this._arbitrage(t.next,c.base==a?h.output:h.quantity,r,s,i,o):{output:c.base==a?h.output:h.quantity,quantities:r,sides:s,symbols:i,wps:o}}_bestPaths(t,e,r){r=r||1;let s=[],i=t.values(),o=i.next();for(;!o.done;){let a=o.value,{output:c,quantities:l,sides:h,symbols:_,wps:d}=this._arbitrage(a,e),b=X(c,e,"percentage"),{bidPrice:T,askPrice:m}=a.pair.getMarketTicker24hr(this),{bidPrice:H,askPrice:Y}=a.next.pair.getMarketTicker24hr(this),{bidPrice:j,askPrice:$}=a.next.next.pair.getMarketTicker24hr(this);!Number.isFinite(b)||b<r?t.delete(a):(a.setOrderXtras({input:e,output:c,multiple:Math.trunc(b*10**3)/10**3,quantities:l,sides:h,symbols:_,wps:d},this),s.push({p:a,path:this.pathCoinToString(a),multiple:Math.trunc(b*10**3)/10**3,input:e,output:c,quantities:l.toString(),sides:h.toString(),bids:[T,H,j].toString(),asks:[m,Y,$].toString()})),o=i.next()}t.clear(),s.length>0&&(s.sort((a,c)=>a.multiple>c.multiple?-1:1).forEach(({p:a})=>t.add(a)),console.table(s.filter((a,c)=>c<5),["path","multiple","output","quantities","sides","bids","asks"]))}async triangleBUSD(t){try{let{free:e}=this.userBalances.get("BUSD");if(e&&parseFloat(e)<100)return console.log("\u{1F4B0} triangleBUSD: busd balance less than 100 !"),new Set;await this._updatePairsTicker24hr(this.pairs(this));let r=new Set(this.BUSDPaths);return this._bestPaths(r,100,t),r}catch(e){throw e}}async _updatePairsTicker24hr(t){try{let{data:e}=await this._client.ticker24hr();t.forEach(r=>{let s=e.find(i=>i.symbol==r.symbol);s&&r.setTicker24hr(s,this)})}catch(e){throw e}}async _stackOrders(t,e,r){try{let{sides:s,symbols:i,quantities:o,wps:a}=e;if(r||(r=0),r>=s.length){this._manageOrders(e,"d"),this.ORDERS_ON_TRADE.delete(t.name());return}let c=d=>{let b=this.STACKS_INFO.filter(m=>!N.default.isEqual(d,m)),T=this.STACKS_INFO.length;for(let m=0;m<T;m++)this.STACKS_INFO.pop();for(let m of b)this.STACKS_INFO.push(m)},l,h=!1;this.on(u.ON_executionReport,d=>{console.log("\u{1F4B1}",u.ON_executionReport,d.X),!h&&(d&&l&&d.c==l.clientOrderId&&d.X=="FILLED"&&(h=!0,c({dataOrder:l,phase:r}),r++,this._stackOrders(t,e,r)),d&&l&&d.C==l.clientOrderId&&d.X=="CANCELED"&&(h=!0,c({dataOrder:l,phase:r}),this._stackOrders(t,e,s.length)))},"REPLACE");let _=O(async()=>{try{if(h){w(_);return}if(l){let{data:d}=await this._client.getOrder(l.symbol,{origClientOrderId:l.clientOrderId,recvWindow:6e3,timestamp:Date.now()});console.log("\u{1F4B1} async check order",d.status,d.symbol),d.status=="FILLED"&&(h=!0,c({dataOrder:l,phase:r}),r++,this._stackOrders(t,e,r)),d.status=="CANCELED"&&(h=!0,c({dataOrder:l,phase:r}),this._stackOrders(t,e,s.length))}}catch(d){this.emit(u.EVT_ERROR,d)}},10**3*15);return l=await this._newOrder(i[r],s[r],"LIMIT",{price:a[r],quantity:o[r]}),e&&e.orders||(e.orders=new Array),e.orders.push(l),this._manageOrders(e,"u"),this.STACKS_INFO.push({dataOrder:l,phase:r}),l}catch(s){this.emit(u.EVT_ERROR,s)}}async _readOrders(){try{let t=__dirname+`/orders.${this.id}.json`,e=M.default.readFileSync(t,{flag:"r+"});return JSON.parse(e.toString())}catch{return[]}}async _writeOrders(t){try{try{let e=__dirname+`/orders.${this.id}.json`;M.default.writeFileSync(e,JSON.stringify(t),{flag:"w+",encoding:"utf8"})}catch(e){throw e}}catch(e){throw e}}async _manageOrders(t,e){try{let r=await this._readOrders();t&&e&&e=="a"&&r.push(t),t&&e&&e=="d"&&(r=r.filter(s=>!N.default.isEqual(s,t))),t&&e&&e=="u"&&(r=r.filter(s=>s.id!=t.id),r.push(t)),e&&await this._writeOrders(r)}catch(r){this.emit(u.EVT_ERROR,r)}}async retrade(){try{let t=await this._readOrders();for(let e of t){let{orders:r,sides:s}=e;if(s.length!=r.length){let{free:i}=this.userBalances.get("BUSD");if(i&&parseFloat(i)<100)continue}}}catch(t){throw t}}async _newOrder(t,e,r,s){try{s.timeInForce=s.timeInForce||"GTC",s.recvWindow=s.recvWindow||5e3;let{data:i}=await this._client.newOrder(t,e,r,s);return i}catch(i){throw i}}async trade(t,e){try{let{free:r}=this.userBalances.get(e||"BUSD");if(r&&parseFloat(r)<100){console.log("\u{1F4B0} busd balance less than 100 !");return}if(this.ORDERS_ON_TRADE.has(t.name())){console.log("\u{1F4B9} this path already existed on trade spot !");return}this.ORDERS_ON_TRADE.add(t.name());let s=t.orderXtras.get(this);s&&!s.id&&(s.id=this.id+"_"+Date.now().toString()),this._manageOrders(s,"a"),this._stackOrders(t,s)}catch(r){throw r}}},f=u;f.EVT_ERROR="binance_error",f.ON_executionReport="executionReport",f.ON_outboundAccountPosition="outboundAccountPosition",f.ON_balanceUpdate="balanceUpdate";var E=[],C=[];process.on("exit",()=>{let n=E.length;for(let t=0;t<n;t++)clearInterval(E[0]),E.shift();n=C.length;for(let t=0;t<n;t++)w(C[0]),C.shift();console.log("\u{1F300} purge Binance")});var F=.32517,p=new f,J=0,U=0,ot=async()=>{console.log("\u{1F535} Main initialize:","selectPercent",F);try{p.on(f.EVT_ERROR,n=>{P("\u274C from binance:evtError",n)}),await p.init(),await ct()}catch(n){P("\u274C from main catch",n)}},ct=async()=>{console.log("\u{1F536} App launched");try{R.push(O(async()=>{try{++U,U%10==0&&console.log("\u{1F916}",U,J,F,"binance: coins",p.coins(p).size,"pairs",p.pairs(p).size,"busd",p.BUSDPaths.size,"paths",p.binancePaths.size),p.STACKS_INFO.length>0&&p.STACKS_INFO.forEach(t=>{let{phase:e,dataOrder:r}=t,{price:s,symbol:i,origQty:o,side:a}=r;console.log("\u2653","phase",e,i,s,o,a)});let n=await p.triangleBUSD(F);if(n.size>0){let t=n.values(),e=t.next(),r=0,s;for(;!e.done;){let i=e.value,o=i.orderXtras.get(p).multiple;o>r&&(s=i,r=o),e=t.next()}if(s)try{await p.trade(s)}catch(i){P("\u274C from app:trade catch",i)}}}catch(n){P("\u274C from app:async catch",n)}},10**3*12))}catch(n){P("\u274C from app catch",n)}},P=(n,t)=>{J++,console.error(n||"\u274C from makeError catch");let e=!0;t&&t.data&&(console.error(t.data),e=!1),t&&t.config&&t.config.url&&(console.error(t.config.url),e=!1),t&&t.response&&t.response&&(console.error(t.response.status,t.response.statusText),e=!1),e&&console.error(t),console.error(n||"\u274C from makeError catch")};ot();var R=[],G=!1,L=()=>{if(G)return;G=!0;let n=R.length;for(let t=0;t<n;t++)w(R[0]),R.shift();console.log("\u{1F300} purge main"),process.exit()};process.on("SIGTERM",L);process.on("SIGINT",L);process.on("exit",L);
