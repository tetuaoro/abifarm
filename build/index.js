var ct=Object.create;var A=Object.defineProperty,lt=Object.defineProperties,ht=Object.getOwnPropertyDescriptor,ut=Object.getOwnPropertyDescriptors,pt=Object.getOwnPropertyNames,L=Object.getOwnPropertySymbols,dt=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty,mt=Object.prototype.propertyIsEnumerable;var X=(s,t,e)=>t in s?A(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,z=(s,t)=>{for(var e in t||(t={}))q.call(t,e)&&X(s,e,t[e]);if(L)for(var e of L(t))mt.call(t,e)&&X(s,e,t[e]);return s},W=(s,t)=>lt(s,ut(t)),ft=s=>A(s,"__esModule",{value:!0});var _t=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of pt(t))!q.call(s,n)&&(e||n!=="default")&&A(s,n,{get:()=>t[n],enumerable:!(r=ht(t,n))||r.enumerable});return s},S=(s,t)=>_t(ft(A(s!=null?ct(dt(s)):{},"default",!t&&s&&s.__esModule?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0})),s);var H=require("../node_modules/dotenv/lib/main.js"),Y=require("../node_modules/@binance/connector/src/index.js");var I=(s,t)=>{if(!s)return;let e=t&&t=="pop";for(let r=0;r<s.length;r++)e?s.pop():s.shift()},V=(s,t,e)=>{let r=s.values(),n=r.next();for(;!n.done;){let{base:i,quote:o}=n.value;if(t===i&&e===o||t===o&&e===i)return n.value;n=r.next()}};var G=(s,t,e)=>t==0?0:e==="percentage"?100*((s-t)/t):(s-t)/t,y=[],P=[],J=async(s,t,e)=>{await s(),y[e]&&P.push(setTimeout(()=>J(s,t,e),t))},O=(s,t)=>{if(s&&typeof s=="function"){let e=y.length;return y.push(!0),t=t||0,J(s,t,e),e}else throw new Error("Callback must be a function")},E=s=>{y[s]&&(y[s]=!1,clearTimeout(P[s])),y.every(t=>t===!1)&&(I(y),I(P))};process.on("exit",()=>{let s=P.length;for(let t=0;t<s;t++)clearInterval(P[0]),P.shift();console.log("\u{1F300} purge utils")});var D=class{constructor(){this.events=new Map;this.stacks=new Map;this.eventsOnce=new Map}on(t,e,r){if(r==="REPLACE"&&this.events.set(t,e),r==="STACK"){let n=this.stacks.get(t);if(!n){let i=new Array;i.push(e),this.stacks.set(t,i);return}n.push(e),this.stacks.set(t,n)}r||this.events.has(t)||this.events.set(t,e)}once(t,e){this.eventsOnce.has(t)||this.eventsOnce.set(t,e)}emit(t,...e){if(console.log("\u{1F442} emit event",t,"with",typeof e,"params"),this.events.has(t)&&this.events.get(t)(...e),this.eventsOnce.has(t)){let r=this.eventsOnce.get(t);this.eventsOnce.delete(t),r(...e)}this.stacks.has(t)&&this.stacks.get(t).forEach(n=>{n(...e)})}},M=class{constructor(t){this.symbol=t,this.stable=this.symbol==="USDT"||this.symbol==="BUSD"||this.symbol==="USDC"||this.symbol==="UST"||this.symbol==="USDP"||this.symbol==="DAI"}},g=class{constructor(t,e,r,n){this.coin=t,this.next=e||null,this.pair=r||null,this.depth=n||1,this.orderXtras=new Map}previous(t){let e=this,r=e;for(;e.next&&e!=t;)r=e,e=e.next;return r}name(){let t="",e=this;for(;e;)t+=e.coin.symbol,e=e.next;return t}setOrderXtras(t,e){this.orderXtras.set(e,t)}setPair(t){if(t instanceof Set){if(!this.next)return;let e=this.coin,r=this;for(;r;)r.setPair(V(t,r.coin,r.next?r.next.coin:e)),r=r.next}else this.pair=t}reverse(){let t=this;for(;t.next;)t=t.next;let e=new g(t.coin,null,t.pair,this.depth),r=e,n=1;for(;n<this.depth;)t=this.previous(t),e.next=new g(t.coin,null,t.pair,this.depth-n),e=e.next,n++;return r}},N=class{constructor(t,e){this.base=t,this.quote=e,this.symbol=t.symbol+e.symbol,this._ticker24hr=new Map,this.filters=new Array}setPrecision(t,e){this._baseAssetPrecision=t,this._quoteAssetPrecision=e}getPrecisions(){return{baseAssetPrecision:this._baseAssetPrecision,quoteAssetPrecision:this._quoteAssetPrecision}}setFilters(t){t.forEach(e=>{this.filters.find(r=>r.filterType==e.filterType)||this.filters.push(e)})}getMarketTicker24hr(t){return this._ticker24hr.get(t)}setTicker24hr(t,e){this._ticker24hr.set(e,t)}};var R=class extends D{constructor(t){super();this.id=t,this._attach=new Map,this._coins=new Map,this._pairs=new Map}addCoin(t,e){let r=this._coins.get(e)||this._coins.set(e,new Set).get(e),n=r.values(),i=n.next(),o;for(;!i.done&&!o;){let a=i.value;a.symbol==t&&(o=a),i=n.next()}return o||(o=new M(t),r.add(o),o)}addPair(t,e,r){let n=this._pairs.get(r)||this._pairs.set(r,new Set).get(r),i=n.values(),o=i.next(),a;for(;!o.done&&!a;){let c=o.value;c.base==t&&c.quote==e&&(a=c),o=i.next()}return a||(a=new N(t,e),n.add(a),a)}coins(t){return this._coins.get(t)}pairs(t){return this._pairs.get(t)}add(t,e){this._attach.has(t)?this._attach.get(t).add(e):this._attach.set(t,new Set([e])),this._attach.has(e)?this._attach.get(e).add(t):this._attach.set(e,new Set([t]))}_dfs(t,e){if(t<=0)return;let n=new Set(e).values(),i=n.next();for(;!i.done;){let o=i.value,a=i.value;i=n.next();let c=new Set;for(;a.next;)c.add(a.next.coin),a=a.next;let l=this._attach.get(o.coin).values(),h=l.next();for(;!h.done;){let b=h.value;h=l.next(),!c.has(b)&&e.add(new g(b,o,null,o.depth+1))}e.delete(o)}this._dfs(t-1,e)}_filter(t,e){e.forEach(r=>{this._attach.get(r.coin).has(t)||e.delete(r)})}pathCoinToString(t){let e="";for(;t;)e+=t.coin.symbol+(t.next?" ":""),t=t.next;return e}};var Z=S(require("../node_modules/lodash/lodash.js"));(0,H.config)();var gt=process.env.BINANCE_API_KEY_PROD,yt=process.env.BINANCE_API_SECRET_PROD,p=class extends R{constructor(){super("binance");this.cummulativeTradeBacks=0;this.cummulativeBUSD=0;this._client=new Y.Spot(gt,yt),this.binancePaths=new Map,this.BUSDPaths=new Set,this.tPairs=new Set,this.userBalances=new Map,this.ORDERS_ON_TRADE=new Set,this.STACKS_INFO=new Array,process.on("exit",()=>{I(this.STACKS_INFO),this.binancePaths.clear(),this.BUSDPaths.clear(),this.tPairs.clear(),this.userBalances.clear(),this.ORDERS_ON_TRADE.clear(),console.log("\u{1F300} purge binance constructor")})}async _account(){try{console.log("\u{1F4B0} update account user data");let{data:t}=await this._client.account();if(t.permissions&&t.permissions.length!=1)throw new Error("The api key needs to be 'SPOT' only !");return t.balances.forEach(e=>{(parseFloat(e.free)!=0||parseFloat(e.locked)!=0)&&(this.userBalances.set(e.asset,e),console.log("\u{1F4B8} asset",e.asset,"free",e.free,"locked",e.locked))}),this.on(p.ON_outboundAccountPosition,e=>{try{e.B.forEach(r=>{this.userBalances.set(r.a,{asset:r.a,free:r.f,locked:r.l})})}catch(r){this.emit(p.EVT_ERROR,r)}}),this.on(p.ON_balanceUpdate,e=>{try{let r=setTimeout(async()=>{await this._account(),clearTimeout(r)},10**3*3)}catch(r){this.emit(p.EVT_ERROR,r)}}),t}catch(t){throw t}}async _startStream(){try{let t={open:()=>console.log("\u{1F440} open stream"),close:()=>console.log("\u{1F440} closed stream"),message:i=>{console.log("ws emitting",i),typeof i=="string"&&(i=JSON.parse(i)),i.e==p.ON_executionReport&&this.emit(p.ON_executionReport,i),i.e==p.ON_outboundAccountPosition&&this.emit(p.ON_outboundAccountPosition,i),i.e==p.ON_balanceUpdate&&this.emit(p.ON_balanceUpdate,i)}},e,r;process.on("exit",()=>{r&&this._client.unsubscribe(r),e&&console.log("unsubscribe ws",e)});let n=O(async()=>{try{if(e&&(await this._client.renewListenKey(e),console.log("\u{1F440} renewed ListenKey")),!e){let{data:i}=await this._client.createListenKey();e=i.listenKey,r=await this._client.userData(e,t),console.log("subscribe ws",e);let o=setInterval(()=>{try{r&&(r.ws.ping(),console.log("Sended ping from client"))}catch(a){this.emit(p.EVT_ERROR,a)}},10**3*60*5);T.push(o)}}catch(i){this.emit(p.EVT_ERROR,i)}},10**3*60*55);C.push(n)}catch(t){throw t}}async init(t){console.log("\u264D Initialize binance");try{await this._startStream(),await this._account();let{data:e}=await this._client.exchangeInfo();e.symbols.forEach(i=>{if(i.orderTypes.includes("LIMIT")&&i.permissions.includes("SPOT")&&i.isSpotTradingAllowed){let o=this.addCoin(i.baseAsset,this),a=this.addCoin(i.quoteAsset,this),c=this.addPair(o,a,this);c.setFilters(i.filters),c.setPrecision(i.baseAssetPrecision,i.quoteAssetPrecision),this.add(o,a)}}),t||(t=3);let r=this.coins(this),n=this.pairs(this);r.forEach(i=>{let o=new Set([new g(i)]);this._dfs(t-1,o),this._filter(i,o),o.forEach(a=>{a=a.reverse(),a.setPair(n),this.binancePaths.set(a.name(),a)})}),this.binancePaths.forEach((i,o)=>{o.startsWith("BUSD")&&this.BUSDPaths.add(i)})}catch(e){throw e}}_normalizeWithLotSize(t,e){try{let{stepSize:r}=t.filters.find(i=>i.filterType=="LOT_SIZE"),n=r.split(".")[1].indexOf("1");return n==-1?Math.trunc(e):Math.trunc(e*10**(n+1))/10**(n+1)}catch(r){throw r}}_getPriceInfo(t,e,r,n){try{let{quoteAssetPrecision:i}=e.getPrecisions(),o,a;return e.base==n?(o=this._normalizeWithLotSize(e,r),a=Math.trunc(o*t*10**i)/10**i,{output:a,side:"SELL",quantity:o,price:t}):(a=Math.trunc(r*10**i)/10**i,o=this._normalizeWithLotSize(e,a/t),a=Math.trunc(t*o*10**i)/10**i,{output:a,side:"BUY",quantity:o,price:t})}catch(i){throw i}}_arbitrage(t,e,r=[],n=[],i=[],o=[]){let a=t.coin,c=t.pair,l=c.base==a?parseFloat(c.getMarketTicker24hr(this).bidPrice):parseFloat(c.getMarketTicker24hr(this).askPrice),h=this._getPriceInfo(l,c,e,a);return i.push(c.symbol),r.push(h.quantity),n.push(h.side),o.push(l),t.next?this._arbitrage(t.next,c.base==a?h.output:h.quantity,r,n,i,o):{output:c.base==a?h.output:h.quantity,quantities:r,sides:n,symbols:i,wps:o}}_bestPaths(t,e,r){r=r||1;let n=[],i=t.values(),o=i.next();for(;!o.done;){let a=o.value,{output:c,quantities:l,sides:h,symbols:b,wps:u}=this._arbitrage(a,e),f=G(c,e,"percentage"),{bidPrice:k,askPrice:_}=a.pair.getMarketTicker24hr(this),{bidPrice:it,askPrice:nt}=a.next.pair.getMarketTicker24hr(this),{bidPrice:at,askPrice:ot}=a.next.next.pair.getMarketTicker24hr(this);!Number.isFinite(f)||f<r?t.delete(a):(a.setOrderXtras({input:e,output:c,multiple:Math.trunc(f*10**3)/10**3,quantities:l,sides:h,symbols:b,wps:u},this),n.push({p:a,path:this.pathCoinToString(a),multiple:Math.trunc(f*10**3)/10**3,input:e,output:c,quantities:l.toString(),sides:h.toString(),bids:[k,it,at].toString(),asks:[_,nt,ot].toString()})),o=i.next()}t.clear(),n.length>0&&(n.sort((a,c)=>a.multiple>c.multiple?-1:1).forEach(({p:a})=>t.add(a)),console.table(n.filter((a,c)=>c<5),["path","multiple","output","quantities","sides","bids","asks"]))}async triangleBUSD(t){try{let{free:e}=this.userBalances.get("BUSD");if(e&&parseFloat(e)<100)return console.log("\u{1F4B0} triangleBUSD: busd balance less than 100 !"),new Set;await this._updatePairsTicker24hr(this.pairs(this));let r=new Set(this.BUSDPaths);return this._bestPaths(r,100,t),r}catch(e){throw e}}async _updatePairsTicker24hr(t){try{let{data:e}=await this._client.ticker24hr();t.forEach(r=>{let n=e.find(i=>i.symbol==r.symbol);n&&r.setTicker24hr(n,this)})}catch(e){throw e}}async _stackOrders(t,e,r){try{let{sides:n,symbols:i,quantities:o,wps:a}=e;if(r||(r=0),r>=n.length){this.ORDERS_ON_TRADE.delete(t.name()),this.cummulativeTradeBacks++;let{multiple:u,input:f}=t.orderXtras.get(this);this.cummulativeBUSD+=Math.trunc(f*u)/100;return}let c=u=>{let f=this.STACKS_INFO.filter(_=>!Z.default.isEqual(u,_)),k=this.STACKS_INFO.length;for(let _=0;_<k;_++)this.STACKS_INFO.pop();for(let _ of f)this.STACKS_INFO.push(_)},l,h=!1;this.on(p.ON_executionReport,u=>{console.log("\u{1F4B1}",p.ON_executionReport,u.X),!h&&(u&&l&&u.c==l.clientOrderId&&u.X=="FILLED"&&(h=!0,r++,this._stackOrders(t,e,r),c({dataOrder:l,phase:r-1})),u&&l&&u.C==l.clientOrderId&&u.X=="CANCELED"&&(h=!0,this._stackOrders(t,e,n.length),c({dataOrder:l,phase:r})))},"REPLACE");let b=O(async()=>{try{if(h){E(b);return}if(l){let{data:u}=await this._client.getOrder(l.symbol,{origClientOrderId:l.clientOrderId,recvWindow:6e3,timestamp:Date.now()});console.log("\u{1F4B1} async check order",u.status,u.symbol),u.status=="FILLED"&&(h=!0,r++,this._stackOrders(t,e,r),c({dataOrder:l,phase:r-1})),u.status=="CANCELED"&&(h=!0,this._stackOrders(t,e,n.length),c({dataOrder:l,phase:r}))}}catch(u){this.emit(p.EVT_ERROR,u)}},10**3*6);l=await this._newOrder(i[r],n[r],"LIMIT",{price:a[r],quantity:o[r]}),e&&e.orders||(e.orders=new Array),e.orders.push(l),this.STACKS_INFO.push({dataOrder:l,phase:r})}catch(n){this.emit(p.EVT_ERROR,n)}}async _newOrder(t,e,r,n){try{n.timeInForce=n.timeInForce||"GTC",n.recvWindow=n.recvWindow||5e3;let{data:i}=await this._client.newOrder(t,e,r,n);return i}catch(i){throw i}}async trade(t,e){try{let{free:r}=this.userBalances.get(e||"BUSD");if(r&&parseFloat(r)<100){console.log("\u{1F4B0} busd balance less than 100 !");return}if(this.ORDERS_ON_TRADE.has(t.name())){console.log("\u{1F4B9} this path already existed on trade spot !");return}this.ORDERS_ON_TRADE.add(t.name());let n=t.orderXtras.get(this);n&&!n.id&&(n.id=this.id+"_"+Date.now().toString()),this._stackOrders(t,n)}catch(r){throw r}}report(t){return t&&t=="RESET"&&(this.cummulativeTradeBacks=0,this.cummulativeBUSD=0),{cummulative_tb:this.cummulativeTradeBacks,cummulative_busd:this.cummulativeBUSD}}},m=p;m.EVT_ERROR="binance_error",m.ON_executionReport="executionReport",m.ON_outboundAccountPosition="outboundAccountPosition",m.ON_balanceUpdate="balanceUpdate";var T=[],C=[];process.on("exit",()=>{let s=T.length;for(let t=0;t<s;t++)clearInterval(T[0]),T.shift();s=C.length;for(let t=0;t<s;t++)E(C[0]),C.shift();console.log("\u{1F300} purge Binance")});var F=S(require("../node_modules/@sendgrid/mail/index.js")),j=S(require("../node_modules/hogan.js/lib/hogan.js")),Q=S(require("../node_modules/inline-css/index.js")),$=S(require("fs")),tt=require("../node_modules/dotenv/lib/main.js");(0,tt.config)();var bt="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",St="bot@rao-nagos.pf",Pt=process.env.SEND_REPORT_EMAIL_TO;F.default.setApiKey(bt);var et=async(s,t)=>{try{let{COUNTER_APP:e,COUNTER_ERRORS:r}=t,n=$.default.readFileSync(__dirname+"/template/report.html"),i={to:Pt,from:St,subject:"Abifarm report"},o=await(0,Q.default)(n.toString(),{url:"file://"+__dirname+"/template/"}),a=j.default.compile(o),c={market:s.id,counter_e:r,counter_a:e,m_coins:s.coins(s).size,m_pairs:s.pairs(s).size,m_paths:s.binancePaths.size,m_paths_busd:s.BUSDPaths.size,m_ctb:s.report().cummulative_tb,m_cbusd:s.report().cummulative_busd},l=a.render(c),h=W(z({},i),{html:l});await F.default.send(h),console.log("\u{1F4E7} report sended !")}catch(e){console.error(e)}};var rt=S(require("../node_modules/node-cron/src/node-cron.js")),B=.32517,d=new m,U=0,v=0,wt=async()=>{console.log("\u{1F535} Main initialize:","selectPercent",B);try{d.on(m.EVT_ERROR,s=>{w("\u274C from binance:evtError",s)}),await d.init(),await Ot()}catch(s){w("\u274C from main catch",s)}},Ot=async()=>{console.log("\u{1F536} App launched");try{x.push(O(async()=>{try{++v,v%10==0&&console.log("\u{1F916}",v,U,B,"binance: coins",d.coins(d).size,"pairs",d.pairs(d).size,"busd",d.BUSDPaths.size,"paths",d.binancePaths.size),d.STACKS_INFO.length>0&&d.STACKS_INFO.forEach(t=>{let{phase:e,dataOrder:r}=t,{price:n,symbol:i,origQty:o,side:a}=r;console.log("\u2653","phase",e,i,n,o,a)});let s=await d.triangleBUSD(B);if(s.size>0){let t=s.values(),e=t.next(),r=0,n;for(;!e.done;){let i=e.value,o=i.orderXtras.get(d).multiple;o>r&&(n=i,r=o),e=t.next()}if(n)try{await d.trade(n)}catch(i){w("\u274C from app:trade catch",i)}}}catch(s){w("\u274C from app:async catch",s)}},10**3*3))}catch(s){w("\u274C from app catch",s)}},w=(s,t)=>{U++,console.error(s||"\u274C from makeError catch");let e=!0;t&&t.data&&(console.error(t.data),e=!1),t&&t.config&&t.config.url&&(console.error(t.config.url),e=!1),t&&t.response&&t.response&&(console.error(t.response.status,t.response.statusText),e=!1),e&&console.error(t),console.error(s||"\u274C from makeError catch")};rt.default.schedule("59 21 * * *",async()=>{try{console.log("---------------------"),console.log("Running Cron Job"),await et(d,{COUNTER_APP:v,COUNTER_ERRORS:U}),d.report("RESET")}catch(s){w("\u274C from cron catch",s)}});wt();var x=[],st=!1,K=()=>{if(st)return;st=!0;let s=x.length;for(let t=0;t<s;t++)E(x[0]),x.shift();console.log("\u{1F300} purge main"),process.exit()};process.on("SIGTERM",K);process.on("SIGINT",K);process.on("exit",K);
